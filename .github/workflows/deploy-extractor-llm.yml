name: Deploy LLM Extractor (CF Gen + Cloud Scheduler)
run-name: "LLM Extractor deploy by ${{ github.actor }} â€¢ ${{ github.ref_name }}"

# ... (on, permissions, env sections remain unchanged) ...
on:
Â  push:
Â  Â  branches: [ main ]
Â  Â  paths:
Â  Â  Â  - 'cloud_function/extractor-llm-poc/**'
Â  Â  Â  - '.github/workflows/deploy-extractor-llm.yml'
Â  workflow_dispatch: {}

permissions:
Â  contents: read
Â  id-token: write

env:
Â  PROJECT_ID: ${{ vars.PROJECT_ID }}
Â  REGION: ${{ vars.REGION }}
Â  FUNCTION_NAME: ${{ vars.EXTRACTOR_LLM_FUNCTION_NAME || 'extractor-llm-poc' }}
Â  FUNCTION_DIR: cloud_function/extractor-llm-poc
Â  ENTRY_POINT: llm_extract_http
Â  RUNTIME: python312
Â  BUCKET_NAME: ${{ vars.BUCKET_NAME }}
Â  RUNTIME_SA: ${{ vars.RUNTIME_SA }}
Â  DEPLOYER_SA: ${{ vars.DEPLOYER_SA }}
Â  WORKLOAD_IDENTITY_PROVIDER: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
Â  LLM_PROVIDER: ${{ vars.LLM_PROVIDER || 'vertex' }}
Â  LLM_MODEL: ${{ vars.LLM_MODEL || 'gemini-1.5-flash' }}
Â  LLM_OVERWRITE: ${{ vars.LLM_OVERWRITE || 'false' }}
Â  LLM_MAX_FILES: ${{ vars.LLM_MAX_FILES || '0' }}
Â  LLM_STRUCTURED_PREFIX: ${{ vars.STRUCTURED_PREFIX || 'structured' }}
Â  SCHEDULE_BODY: ${{ vars.EXTRACTOR_LLM_BODY || '{"overwrite":false,"max_files":0}' }}
Â  CRON_EXPR: "12 * * * *"

jobs:
Â  deploy:
Â  Â  runs-on: ubuntu-latest
Â  Â  steps:
Â  Â  Â  - uses: actions/checkout@v4

Â  Â  Â  # --- 1. AUTHENTICATION & SETUP ---
Â  Â  Â  - name: Auth (WIF)
Â  Â  Â  Â  uses: google-github-actions/auth@v
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
Â  Â  Â  Â  Â  service_account: ${{ env.DEPLOYER_SA }}
Â  Â  Â  Â  Â  create_credentials_file: true
Â  Â  Â  Â  Â  export_environment_variables: true

Â  Â  Â  - name: Setup gcloud
Â  Â  Â  Â  uses: google-github-actions/setup-gcloud@v
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  project_id: ${{ env.PROJECT_ID }}

Â  Â  Â  - name: Ensure required APIs enabled (Vertex AI, Scheduler, Artifact Registry)
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  set -euo pipefail
Â  Â  Â  Â  Â  # Include Artifact Registry API
Â  Â  Â  Â  Â  for API in aiplatform.googleapis.com cloudscheduler.googleapis.com artifactregistry.googleapis.com; do
Â  Â  Â  Â  Â  Â  gcloud services list --enabled --filter="$API" --format="value(config.name)" | grep -q "$API" \
Â  Â  Â  Â  Â  Â  Â  || gcloud services enable "$API"
Â  Â  Â  Â  Â  done
Â  Â  Â  Â  Â Â 
Â  Â  Â  # ðŸ’¥ NEW STEP TO FIX CRASH ðŸ’¥
Â  Â  Â  - name: Ensure Artifact Registry Ready (CF Gen)
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  # The CF Gen default repository is 'cloud-functions' with 'docker' format
Â  Â  Â  Â  Â  set +e # Allow gcloud command to fail if repo already exists
Â  Â  Â  Â  Â  gcloud artifacts repositories create cloud-functions \
Â  Â  Â  Â  Â  Â  --repository-format=docker \
Â  Â  Â  Â  Â  Â  --location="${REGION}" \
Â  Â  Â  Â  Â  Â  --description="Cloud Functions Gen deployment repository"
Â  Â  Â  Â  Â  set -e # Restore strict execution

Â  Â  Â  # --- . CLOUD FUNCTION DEPLOYMENT ---
Â  Â  Â  - name: Deploy Cloud Function (Gen)
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  set -euo pipefail
Â  Â  Â  Â  Â  SA_ARGS=()
Â  Â  Â  Â  Â  if [[ -n "${RUNTIME_SA:-}" ]]; then
Â  Â  Â  Â  Â  Â  gcloud iam service-accounts describe "${RUNTIME_SA}" >/dev/null >&1
Â  Â  Â  Â  Â  Â  SA_ARGS=(--service-account="${RUNTIME_SA}")
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  gcloud functions deploy "${FUNCTION_NAME}" \
Â  Â  Â  Â  Â  Â  --gen2 \
Â  Â  Â  Â  Â  Â  --region="${REGION}" \
Â  Â  Â  Â  Â  Â  --runtime="${RUNTIME}" \
Â  Â  Â  Â  Â  Â  --source="${FUNCTION_DIR}" \
Â  Â  Â  Â  Â  Â  --entry-point="${ENTRY_POINT}" \
Â  Â  Â  Â  Â  Â  --trigger-http \
Â  Â  Â  Â  Â  Â  --no-allow-unauthenticated \
              --memory=1024Mi \  # <-- ðŸ’¥ MEMORY FIX APPLIED HERE ðŸ’¥
Â  Â  Â  Â  Â  Â  "${SA_ARGS[@]}" \
Â  Â  Â  Â  Â  Â  --set-env-vars="PROJECT_ID=${PROJECT_ID},GCS_BUCKET=${BUCKET_NAME},STRUCTURED_PREFIX=${LLM_STRUCTURED_PREFIX},LLM_PROVIDER=${LLM_PROVIDER},LLM_MODEL=${LLM_MODEL},OVERWRITE=${LLM_OVERWRITE},MAX_FILES=${LLM_MAX_FILES}"

Â  Â  Â  - name: Get Function URL
Â  Â  Â  Â  id: cfurl
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  URL=$(gcloud functions describe "${FUNCTION_NAME}" --gen2 --region "${REGION}" --format='value(serviceConfig.uri)')
Â  Â  Â  Â  Â  echo "url=${URL}" >> "$GITHUB_OUTPUT"

Â  Â  Â  # --- 3. IAM GRANTS (RUNTIME AND DEPLOYER SAs) ---
Â  Â  Â Â 
Â  Â  Â  - name: Grant invoker to deployer & runtime SAs
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  gcloud functions add-invoker-policy-binding "${FUNCTION_NAME}" \
Â  Â  Â  Â  Â  Â  --gen2 --region "${REGION}" \
Â  Â  Â  Â  Â  Â  --member="serviceAccount:${DEPLOYER_SA}"
Â  Â  Â  Â  Â  gcloud functions add-invoker-policy-binding "${FUNCTION_NAME}" \
Â  Â  Â  Â  Â  Â  --gen2 --region "${REGION}" \
Â  Â  Â  Â  Â  Â  --member="serviceAccount:${RUNTIME_SA}"

Â  Â  Â  - name: Grant Vertex AI user to runtime SA (for Gemini calls)
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  set -euo pipefail
Â  Â  Â  Â  Â  if [[ -n "${RUNTIME_SA:-}" ]]; then
Â  Â  Â  Â  Â  Â  gcloud projects add-iam-policy-binding "${PROJECT_ID}" \
Â  Â  Â  Â  Â  Â  Â  --member="serviceAccount:${RUNTIME_SA}" \
Â  Â  Â  Â  Â  Â  Â  --role="roles/aiplatform.user" || {
Â  Â  Â  Â  Â  Â  Â  Â  echo "::warning:: Could not grant roles/aiplatform.user to ${RUNTIME_SA}. Ensure this binding exists once."
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  echo "::error::RUNTIME_SA is not set. Add repo variable RUNTIME_SA."
Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â Â 
Â  Â  Â  - name: Grant GCS Object Admin to runtime SA (for R/W data)
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  set -euo pipefail
Â  Â  Â  Â  Â  if [[ -n "${RUNTIME_SA:-}" ]]; then
Â  Â  Â  Â  Â  Â  gcloud storage buckets add-iam-policy-binding gs://${BUCKET_NAME} \
Â  Â  Â  Â  Â  Â  Â  --member="serviceAccount:${RUNTIME_SA}" \
Â  Â  Â  Â  Â  Â  Â  --role="roles/storage.objectAdmin" || {
Â  Â  Â  Â  Â  Â  Â  Â  echo "::warning:: Could not grant roles/storage.objectAdmin to ${RUNTIME_SA}. Ensure this binding exists once."
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  echo "::error::RUNTIME_SA is not set. Add repo variable RUNTIME_SA."
Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  fi
Â  Â  Â Â 
Â  Â  Â  # --- 4. CLOUD SCHEDULER SETUP (OIDC) ---

Â  Â  Â  - name: Bootstrap IAM for Scheduler OIDC (runtime SA)
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  set -euo pipefail
Â  Â  Â  Â  Â  PROJECT_NUMBER="$(gcloud projects describe "${PROJECT_ID}" --format='value(projectNumber)')"
Â  Â  Â  Â  Â  SCHED_AGENT="service-${PROJECT_NUMBER}@gcp-sa-cloudscheduler.iam.gserviceaccount.com"
Â  Â  Â  Â  Â  echo "Scheduler agent: ${SCHED_AGENT}"

Â  Â  Â  Â  Â  gcloud iam service-accounts add-iam-policy-binding "${RUNTIME_SA}" \
Â  Â  Â  Â  Â  Â  --member="serviceAccount:${SCHED_AGENT}" \
Â  Â  Â  Â  Â  Â  --role="roles/iam.serviceAccountTokenCreator" || {
Â  Â  Â  Â  Â  Â  Â  echo "::error::Permission denied adding tokenCreator to ${RUNTIME_SA}. Run (once as project owner):"
Â  Â  Â  Â  Â  Â  Â  echo "gcloud iam service-accounts add-iam-policy-binding \"${RUNTIME_SA}\" --member=\"serviceAccount:${SCHED_AGENT}\" --role=\"roles/iam.serviceAccountTokenCreator\""
Â  Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  gcloud iam service-accounts add-iam-policy-binding "${RUNTIME_SA}" \
Â  Â  Â  Â  Â  Â  --member="serviceAccount:${DEPLOYER_SA}" \
Â  Â  Â  Â  Â  Â  --role="roles/iam.serviceAccountUser" || {
Â  Â  Â  Â  Â  Â  Â  echo "::error::Permission denied adding ServiceAccountUser for ${DEPLOYER_SA} on ${RUNTIME_SA}. Run:"
Â  Â  Â  Â  Â  Â  Â  echo "gcloud iam service-accounts add-iam-policy-binding \"${RUNTIME_SA}\" --member=\"serviceAccount:${DEPLOYER_SA}\" --role=\"roles/iam.serviceAccountUser\""
Â  Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  - name: Create/Update Cloud Scheduler job (:1 ET, uses runtime SA OIDC)
Â  Â  Â  Â  shell: bash
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  set -euo pipefail
Â  Â  Â  Â  Â  JOB_NAME="${FUNCTION_NAME}-hourly"
Â  Â  Â  Â  Â  URL="${{ steps.cfurl.outputs.url }}"
Â  Â  Â  Â  Â  [[ -z "${URL}" ]] && { echo "Function URL empty"; exit 1; }

Â  Â  Â  Â  Â  if gcloud scheduler jobs describe "$JOB_NAME" --location="${REGION}" >/dev/null >&1; then
Â  Â  Â  Â  Â  Â  gcloud scheduler jobs update http "$JOB_NAME" \
Â  Â  Â  Â  Â  Â  Â  --location="${REGION}" \
Â  Â  Â  Â  Â  Â  Â  --schedule="${CRON_EXPR}" \
Â  Â  Â  Â  Â  Â  Â  --time-zone="America/New_York" \
Â  Â  Â  Â  Â  Â  Â  --uri="${URL}" \
Â  Â  Â  Â  Â  Â  Â  --http-method=POST \
Â  Â  Â  Â  Â  Â  Â  --message-body='${{ env.SCHEDULE_BODY }}' \
Â  Â  Â  Â  Â  Â  Â  --oidc-service-account-email="${RUNTIME_SA}" \
Â  Â  Â  Â  Â  Â  Â  --oidc-token-audience="${URL}"
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  gcloud scheduler jobs create http "$JOB_NAME" \
Â  Â  Â  Â  Â  Â  Â  --location="${REGION}" \
Â  Â  Â  Â  Â  Â  Â  --schedule="${CRON_EXPR}" \
Â  Â  Â  Â  Â  Â  Â  --time-zone="America/New_York" \
Â  Â  Â  Â  Â  Â  Â  --uri="${URL}" \
Â  Â  Â  Â  Â  Â  Â  --http-method=POST \
Â  Â  Â  Â  Â  Â  Â  --message-body='${{ env.SCHEDULE_BODY }}' \
Â  Â  Â  Â  Â  Â  Â  --oidc-service-account-email="${RUNTIME_SA}" \
Â  Â  Â  Â  Â  Â  Â  --oidc-token-audience="${URL}"
Â  Â  Â  Â  Â  fi

name: Data Sync: Hourly Predictions to Repo
run-name: Syncing hourly predictions for ${{ github.ref_name }} by @${{ github.actor }} 

on:
  schedule:
    - cron: '45 * * * *' # Every hour at 45 minutes past the hour
  workflow_dispatch: 

permissions:
  contents: write # Needed to commit and push files
  id-token: write # Needed for WIF authentication

# Inherit variables from your existing setup
env:
  PROJECT_ID: ${{ vars.PROJECT_ID }}
  BUCKET_NAME: ${{ vars.BUCKET_NAME }}
  WORKLOAD_IDENTITY_PROVIDER: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
  DEPLOYER_SA: ${{ vars.DEPLOYER_SA }}
  GCS_PREDS_PREFIX: "structured/preds" # Base path for your prediction folders
  OUTPUT_DIR: "results" # Local folder to store all timestamped files

jobs:
  sync_data:
    runs-on: ubuntu-latest
    steps:
      # --- SETUP ---
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Auth (WIF) and Setup gcloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.DEPLOYER_SA }}
      
      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # 2. DOWNLOAD AND RENAME DATA
      - name: Find Latest Run ID, Download, and Rename File
        shell: bash
        run: |
          set -euo pipefail
          
          # 2a. Find the LATEST folder/run_id in GCS (the newest subdirectory)
          LATEST_RUN_DIR=$(gsutil ls -d gs://${BUCKET_NAME}/${GCS_PREDS_PREFIX}/*/ | tail -1)
          
          # 2b. Extract the timestamp (folder name, e.g., 2025120816)
          # The sed command removes the GCS path elements and the trailing slash
          LATEST_RUN_ID=$(echo "$LATEST_RUN_DIR" | sed -E "s|gs://${BUCKET_NAME}/${GCS_PREDS_PREFIX}/||; s|/||")
          
          echo "Detected latest run ID: $LATEST_RUN_ID"
          echo "LATEST_RUN_ID=$LATEST_RUN_ID" >> "$GITHUB_ENV" # Save for commit message

          # 2c. Define paths
          GCS_SOURCE_FILE="${{ env.GCS_PREDS_PREFIX }}/$LATEST_RUN_ID/preds.csv"
          LOCAL_TARGET_FILE="${{ env.OUTPUT_DIR }}/$LATEST_RUN_ID-preds.csv" # New name includes the ID
          
          # Create local folder if it doesn't exist
          mkdir -p ${{ env.OUTPUT_DIR }} 
          
          # 2d. Copy from GCS to the new local, timestamped filename
          gsutil cp gs://${BUCKET_NAME}/${GCS_SOURCE_FILE} ${LOCAL_TARGET_FILE}
          
          echo "Successfully copied: gs://${BUCKET_NAME}/${GCS_SOURCE_FILE} to ${LOCAL_TARGET_FILE}"

      # 3. COMMIT AND PUSH
      - name: Commit and Push New Timestamped File
        if: success()
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Stage the newly created timestamped file using the ID saved in GITHUB_ENV
          git add ${{ env.OUTPUT_DIR }}/${{ env.LATEST_RUN_ID }}-preds.csv
          
          # Commit using the extracted ID
          git commit -m "ðŸ¤– Data Sync: Add hourly prediction file for run ${{ env.LATEST_RUN_ID }}"
          git push
